<html>
<head>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<script>
var w = document.body.clientWidth
var h = document.body.clientHeight
var size = 10;
var lines = Math.ceil(h/size);
var columns = Math.ceil(w/size);
var offset = (w - columns*size)/2;
// var fix = Math.floor(size * 0.05);
var fix = 1;
var c = document.createElement('canvas');
c.width = w;
c.height = h;
document.body.appendChild(c);

var c2 = document.createElement('canvas');
c2.width = w;
c2.height = h;

var animData = [];
var animData2 = [];

let font = `900 ${size}px "M+ 2p"`;

document.fonts.load(font, 'あ').then(() => {
  var ctx = c2.getContext('2d');
  ctx.font = font;

  ctx.fillStyle = "#444444";

  for(var i = 0; i < lines; i++) {
    ctx.fillText(generateLine(columns),offset,(size-fix)+size*i);
  }

  for(var i = 0; i < columns; i++) {
    var r = Math.floor(Math.random()*49)+7;
    var s = Math.floor(Math.random()*2)+1;
    var t = -Math.floor(Math.random()*40);
    // var u = Math.floor(Math.random()*2);
    animData[i] = {len: r, frames: s, cycle: s, pos: t};
    r = Math.floor(Math.random()*49)+7;
    s = Math.floor(Math.random()*2)+1;
    t = -Math.floor(Math.random()*40)-40;
    // u = Math.floor(Math.random()*2);
    animData2[i] = {len: r, frames: s, cycle: s, pos: t};
  }

  draw();
});

function draw() {
  // requestAnimationFrame(draw); // do a time check... vs setTimeout? hm.. comparisons are quick right? polyfilling.
  // var s = Date.now();
  setTimeout(draw, 60); // skip canvas manip if there's no time?
  var ctx = c.getContext('2d');

  ctx.globalCompositeOperation = 'source-over';

  ctx.clearRect(0,0,w,h);

  for(var i = 0; i < columns; i++) {
    var ad = animData[i];
    if(ad.cycle++ >= ad.frames) {
      ad.cycle = 1;
      // var j = (ad.frames === 1 && ad.two > 0) ? 2 : 1;
      // while(j > 0) {
        ad.pos++;
      //   j--;
      // }
      if(ad.pos-ad.len-1 > lines) ad.pos = -Math.floor(Math.random()*140);
    }
    // var start = Math.floor(Math.random()*lines)-8;
    // var end = Math.floor(Math.random()*(lines-4)+4+start);
    var start = ad.pos - ad.len -1;
    var end = ad.pos;
    var gradient=ctx.createLinearGradient(0,start*size,0,end*size);
    gradient.addColorStop(0.0,'rgba(40,160,70,0)');
    gradient.addColorStop(0.45,'rgba(40,160,70,1.0)');
    gradient.addColorStop(0.85,'rgba(40,160,70,1.0)');
    gradient.addColorStop(1.0,'rgba(110,240,140,1.0)');
    ctx.fillStyle=gradient;
    ctx.fillRect(offset+i*size,fix+(start)*size,size,(end-start)*size);
  }

  for(var i = 0; i < columns; i++) {
    var ad = animData2[i];
    if(ad.cycle++ >= ad.frames) {
      ad.cycle = 1;
      // var j = (ad.frames === 1 && ad.two > 0) ? 2 : 1;
      // while(j > 0) {
        ad.pos++;
      //   j--;
      // }
      if(ad.pos-ad.len-1 > lines) ad.pos = -Math.floor(Math.random()*140);
    }
    // var start = Math.floor(Math.random()*lines)-8;
    // var end = Math.floor(Math.random()*(lines-4)+4+start);
    var start = ad.pos - ad.len -1;
    var end = ad.pos;
    var gradient=ctx.createLinearGradient(0,start*size,0,end*size);
    // gradient.addColorStop(0.0,'rgba(20,70,160,0)');
    // gradient.addColorStop(0.45,'rgba(20,70,160,1.0)');
    // gradient.addColorStop(0.85,'rgba(20,70,160,1.0)');
    // gradient.addColorStop(1.0,'rgba(60,140,240,1.0)');
    gradient.addColorStop(0.0,'rgba(40,160,70,0)');
    gradient.addColorStop(0.45,'rgba(40,160,70,1.0)');
    gradient.addColorStop(0.85,'rgba(40,160,70,1.0)');
    gradient.addColorStop(1.0,'rgba(110,240,140,1.0)');
    ctx.fillStyle=gradient;
    ctx.fillRect(offset+i*size,fix+(start)*size,size,(end-start)*size);
  }

  ctx.globalCompositeOperation = 'destination-in';
  ctx.drawImage(c2,0,0);


  // ctx = c2.getContext('2d');
  // ctx.scale(1.05,1.05);
  // ctx.drawImage(c2,0,0);
  // console.log(Date.now() - s, 'ms');
}

function generateLine(length) {
  var chars = "あいうえおかきくけこさしすせそたちつてとなにぬね"
            + "のはひふへほまみむめもやゆよらりるれろわゐゑをん"
            + "アイウエオカキクケコサシスセソタチツテトナニヌネ"
            + "ノハヒフヘホマミムメモヤユヨラリルレロワヰヱヲン";
  var text = "";
  for(var i = 0; i < length; i++) {
    var r = Math.floor(Math.random()*chars.length);
    text += chars.slice(r,r+1);
  }
  return text;
}

// generate the text - ask a mask!
//
//
// mask the stuff using https://developer.mozilla.org/samples/canvas-tutorial/6_1_canvas_composite.html
// source-in vs destenation-out
//
//
//

</script>
</body>
</html>